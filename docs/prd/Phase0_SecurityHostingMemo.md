# 절대 지령
- 각 단계는 승인 후에만 진행한다.
- 단계 착수 전 이번 단계 전체 범위를 리뷰하고 오류를 식별한다.
- 오류 발견 시 수정 전에 승인 재요청한다.
- 이전 단계 오류가 없음을 재확인한 뒤 다음 단계 승인을 요청한다.
- 모든 단계 작업은 백그라운드 방식으로 수행한다.
- 문서/웹뷰어 점검이 필요한 경우 반드시 승인 확인 후 진행한다.
- 다음 단계 착수 전에 이전 단계 전반을 재점검하여 미해결 오류가 없는지 확인한다.
- 만약 오류나 사용자의 지시로 task나 절대지령이 수정될시 취소선으로 기존 지시나 이력을 보존하고, 아래에 추가한다.
- 모든 웹은 codex가 테스트 실시 후 이상 없을시 보고한다.
- 1인 개발자와 codex가 같이 협업하며, 모든 산출물은 codex가 작업한다. 중간 중간 성능 향상이나 기능 향상을 위해 제안하는 것을 목표로한다.
- 이 서비스는 사내 내부망으로 운영될 예정이며, 외부 서버나 클라우드 사용은 절대 금한다.
- local 호스트 서버를 통해 PoC를 1인 개발자와 같이 진행하며, 테스트 완료시 1인 개발자 PC를 서버로하여 사내망에 릴리즈한다.
- 코딩과 IT기술을 전혀 모르는 인원도 쉽게 PoC가 가능하도록 Docker나 기타 exe 형태로 배포할 방법을 검토하며 개발 진행한다.
- 모든 스프린트 태스크는 전용 스프린트 Task List를 참조하고, docs/sprint 명세에 따른 영어 로그북 + 설명적 코드 주석을 남김.

> PRD: docs/PRD_MCS.md  
> Task Lists: docs/MCMS_TaskList.md, docs/Tasks_MCS.md, ~~docs/Tasks_ML_Routing.md~~ (폐기 2025-09-30)  
> Remaining Tasks: 0

## 절대 지령
- 각 단계는 승인 후에만 진행한다.
- 단계 착수 전 이번 단계 전체 범위를 리뷰하고 오류를 식별한다.
- 오류 발견 시 수정 전에 승인 재요청한다.
- 이전 단계 오류가 없음을 재확인한 뒤 다음 단계 승인을 요청한다.
- 모든 단계 작업은 백그라운드 방식으로 수행한다.
- 문서/웹뷰어 점검이 필요한 경우 반드시 승인 확인 후 진행한다.
- 다음 단계 착수 전에 이전 단계 전반을 재점검하여 미해결 오류가 없는지 확인한다.
- 만약 오류나 사용자의 지시로 task나 절대지령이 수정될시 취소선으로 기존 지시나 이력을 보존하고, 아래에 추가한다.
- 모든 웹은 codex가 테스트 실시 후 이상 없을시 보고한다.
- 1인 개발자와 codex가 같이 협업하며, 모든 산출물은 codex가 작업한다. 중간 중간 성능 향상이나 기능 향상을 위해 제안하는 것을 목표로한다.
- 이 서비스는 사내 내부망으로 운영될 예정이며, 외부 서버나 클라우드 사용은 절대 금한다.
- local 호스트 서버를 통해 PoC를 1인 개발자와 같이 진행하며, 테스트 완료시 1인 개발자 PC를 서버로하여 사내망에 릴리즈한다.
- 코딩과 IT기술을 전혀 모르는 인원도 쉽게 PoC가 가능하도록 Docker나 기타 exe 형태로 배포할 방법을 검토하며 개발 진행한다.
- 모든 스프린트 태스크는 전용 스프린트 Task List를 참조하고, docs/sprint 명세에 따른 영어 로그북 + 설명적 코드 주석을 남김.
# Phase 0 산출물 - 인증·보안·호스팅 정책 메모

## 1. 인증/인가
- ~~방식: Windows Integrated Authentication(Kerberos/NTLM) + AD 그룹 매핑.~~
- ~~방식: 이메일 기반 자체 회원가입 + Magic Link 인증.~~
- 방식: 이메일 기반 가입 요청 후 관리자 수동 승인.
- ~~가입 흐름: 사용자가 이메일을 입력하면 검증 토큰이 담긴 링크를 발송하고, 링크를 열면 JWT 세션을 발급한다.~~
- 가입 흐름: 이메일을 제출하면 `status=pending`으로 저장되고, 관리자가 승인한 후 로그인 가능.
- 데이터 저장: Next.js Route Handler가 JSON/SQLite에 사용자/승인/세션 정보를 저장한다.
- 감사 로깅: 가입/승인/로그인/로그아웃 이벤트를 `logs/auth/YYYYMMDD.log`에 남긴다.

## 2. 보안 정책
- HTTP(포트 4000)만 노출하고 라우터에서 외부 포트는 모두 차단한다.
- ~~이메일 토큰 만료 시간 10분, 1회 사용 원칙. 재사용 시 즉시 폐기하고 관리자에게 알림 메일을 발송한다.~~
- 승인 대기 30분마다 사용자 목록을 점검하고, 불필요한 요청은 삭제한다.
- 세션/쿠키: HttpOnly + SameSite=Lax, Secure=false(로컬). 로그아웃 시 세션 파일에서 제거한다.
- Content Security Policy: self + localhost 리소스만 허용, inline script 최소화.
- 파일 업로드: MIME/확장자 검사, 500MB 초과 시 Chunk Upload + SHA-256 검증.
- 코드 스캐닝: ESLint/Type Checking과 offline ZAP baseline을 주 1회 실행해 보고서를 보관한다.

## 3. 호스팅 가이드 (로컬 PC 서버)
- 환경: Windows 11 Pro, Node.js 20 LTS, npm 10.x.
- 프로세스: `npm install` → `npm run build` → `npm run start -- -p 4000`.
- 서비스 자동화: 필요 시 `pm2 start npm --name mcms -- run start -- -p 4000` 또는 작업 스케줄러 이용.
- ~~이메일 발송: Nodemailer + Gmail/SendGrid SMTP. `.env.local`에 `SMTP_HOST/SMTP_PORT/SMTP_USER/SMTP_PASS/EMAIL_FROM`을 정의한다.~~
- 이메일 발송 없음: 가입 내역은 로컬 데이터에 저장되고, 관리자 승인 후 로그인 허용.
- 로그 경로: `%USERPROFILE%\AppData\Local\MCMS\logs` (서버), `logs/auth` (인증), `logs/app` (응용프로그램).
- 장애 대응: 프로세스 중단 시 `npm run start` 재실행 → `logs/app/server.log` 확인 → 필요 시 `npm run build` 재시도.

## 4. 보안 점검 항목 (Phase 2 이전 완료)
- 이메일 인증 토큰 스키마/만료 처리 검증.
- ~~Magic Link 재사용 차단 및 토큰 정리 배치 스크립트 작성.~~
- 승인 대기 데이터 정리 스크립트 작성 (30일 초과 삭제).
- ~~SMTP 계정 접근 통제: 앱 비밀번호 또는 API Key 발급.~~
- 로컬 방화벽 규칙 문서화 및 포트 4000 허용 확인.

## 5. 승인 필요 목록
- 로컬 PC에서 Node 프로세스 실행 권한(관리자) 확보.
- SMTP 서비스 계정/비밀번호 발급 및 테스트 메일 허용 확인.
- 이메일 발송 도메인(또는 Gmail/SendGrid) 사용 승인.

## 6. 이메일 인증 검증 로그 (2025-09-29)
- ~~`.env.local`에 SMTP 변수 입력 후 `npm run dev` 실행.~~
- `/auth/register`에서 `codex+uat@example.com` 가입 → `data/users.json`에 pending으로 저장 확인.
- 관리자 페이지 `/auth/admin`에서 승인 후 `/auth/login`에서 로그인 성공 여부 확인.
- 로그인 성공 후 `data/sessions.json`과 `logs/auth/20250929.log`에 기록되는지 점검.
- 오류 발생 시 `logs/auth/20250929.log`에서 원인 파악.

---
2025-09-26 Codex: 인증/호스팅 정책을 Azure AD SSO에서 Windows 통합 인증 + 내부망 전용으로 전환.
2025-09-26 Codex: IIS/SPN/권한 매핑 검증 로그 추가 및 run-smoke 자동화 링크 기록.
~~2025-09-29 Codex: 이메일 기반 자체 회원가입 + Magic Link 인증으로 전환하고, 로컬 PC(Node 20) 호스팅 정책을 정의. SMTP 환경 변수 템플릿과 장애 대응 절차를 업데이트.~~
2025-09-29 Codex: 이메일 가입 + 관리자 수동 승인 플로우로 문서를 재정비하고, 로컬 PC(Node 20) 호스팅 정책/로그 절차를 업데이트.

