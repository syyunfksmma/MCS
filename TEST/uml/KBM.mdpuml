@startuml Button4_KBM_Process

!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 600

skinparam sequence {
    GroupBackgroundColor #E6E6FA
    GroupBorderColor #8A2BE2
    GroupBorderThickness 2
}

title Button 4: KBM Process (TEST_Btn4) - Feature Process Application

actor User #87CEEB
participant "AddinUi" as UI #98FB98
participant "KBMProcessManager" as KBMManager #FFB6C1
participant "ProcessManager" as ProcessMgr #E0FFFF
participant "Esprit.Application" as Esprit #D3D3D3

== Button Click Event ==
User -> UI : Click "KBM" button (TEST_Btn4)
activate UI #98FB98
UI -> KBMManager : new KBMProcessManager(Main._espritApplication)
activate KBMManager #FFB6C1
UI -> KBMManager : ApplyFeatureProcess()

== Feature Validation ==
KBMManager -> KBMManager : GetValidFeatures()
KBMManager -> Esprit : Document.GraphicsCollection
note right of KBMManager
    **Feature Filtering:**
end note
Esprit --> KBMManager : GraphicsCollection

alt No Valid Features Found
    KBMManager -> KBMManager : ShowError("No valid features found")
    KBMManager -> UI : MessageBox.Show("No valid features found")
    KBMManager --> UI : Process terminated
else Valid Features Exist
    group Process Each Feature [#F0E8FF]
        loop for each valid feature
            KBMManager -> KBMManager : ApplyProcessToFeature(feature)
            activate ProcessMgr #E0FFFF
            KBMManager -> ProcessMgr : GetProcesses(ref featureObj, ref espritApp)
            
            note right of ProcessMgr
                **Process Discovery:**
                • Search KBM database for matching processes
            end note
            
            ProcessMgr --> KBMManager : processes array
            
            alt Processes Found
                KBMManager -> ProcessMgr : ApplyProcessItem(processes[0], ref featureObj, ref espritApp)
                ProcessMgr -> Esprit : Apply process to feature
                ProcessMgr --> KBMManager : Process applied
                KBMManager -> KBMManager : LogInfo("ProcessManager", "Applied Process: {name}")
                KBMManager -> Esprit : EventWindow.AddMessage(Information)
            else No Processes Found
                note over KBMManager
                    **No Action Taken**
                    Silent skip to next feature
                end note
            end
            deactivate ProcessMgr
        end
    end
end

== Error Handling ==
alt Exception Occurs
    KBMManager -> KBMManager : LogError("Process Manager", error message)
    KBMManager -> Esprit : EventWindow.AddMessage(Error)
end

KBMManager --> UI : Process complete
deactivate KBMManager
UI --> User : KBM process finished
deactivate UI

@enduml